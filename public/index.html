<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <link
            rel="stylesheet"
            href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
            integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh"
            crossorigin="anonymous"
        />
        <link
            rel="stylesheet"
            href="https://use.fontawesome.com/releases/v5.5.0/css/all.css"
            integrity="sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU"
            crossorigin="anonymous"
        />
        <link rel="stylesheet" type="text/css" href="css/mystyle.css" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Formulario de ingresos de datos</title>
    </head>
    <body>
        <button type="button" class="btn btn-primary btn-lg" data-toggle="modal" data-target="#myModal">Cargue sus datos</button>

        <!-- Modal -->
        <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-body">
                        <form>
                            <div class="row">
                                <div class="col">
                                    <input type="text" class="form-control" placeholder="Nombre" id="nombre" />
                                </div>
                                <div class="col">
                                    <input type="text" class="form-control" placeholder="Apellido" id="apellido" />
                                </div>
                            </div>
                            <br />
                            <div class="row">
                                <div class="col">
                                    <input type="text" class="form-control" placeholder="Edad" id="edad" />
                                </div>
                                <div class="col">
                                    <input type="text" class="form-control" placeholder="Alias" id="alias" />
                                </div>
                            </div>
                            <br />
                            <div class="form-group">
                                <label for="email">Email</label>
                                <input type="email" class="form-control" id="email" aria-describedby="emailHelp" placeholder="Enter email" />
                                <small id="emailHelp" class="form-text text-muted">Esto queda entre nosotres.</small>
                            </div>
                            <div class="form-group">
                                <label for="avatar">Ingrese la url de su avatar</label>
                                <input type="text" class="form-control" id="avatar" placeholder="Avatar" />
                            </div>
                            <button type="button" class="btn btn-primary" id="botonSub">Submit</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        <div class="container mt-5 mb-5">
            <div class="row">
                <div class="col-md-6 offset-md-3">
                    <h4>ChatRoom</h4>
                    <ul class="timeline" id="msgList"></ul>
                    <ul>
                        <div class="card-footer">
                            <div class="input-group">
                                <textarea id="mensaje" class="form-control type_msg" placeholder="Type your message..."></textarea>
                                <div class="input-group-append" id="submitMsg">
                                    <span class="input-group-text send_btn"><i class="fas fa-location-arrow"></i></span>
                                </div>
                            </div>
                        </div>
                    </ul>
                </div>
            </div>
        </div>

        <script src="https://cdn.socket.io/3.1.1/socket.io.min.js" integrity="sha384-gDaozqUvc4HTgo8iZjwth73C6dDDeOJsAgpxBcMpZYztUfjHXpzrpdrHRdVp8ySO" crossorigin="anonymous"></script>

        <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous"></script>

        <script
            src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"
            integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6"
            crossorigin="anonymous"
        ></script>
        <script>
            'https://cdn.jsdelivr.net/npm/normalizr@3.6.1/dist/normalizr.browser.min.js';

        </script>
        <script>
            const socket = io();

            console.log('conectando socket');
            let { id, nombre, apellido, edad, alias, avatar, texto } = '';

            socket.on('conexion', (data) => {
                socket.emit('bienvenida', `Hola, recien me conecto`);
            });

            document.getElementById('botonSub').addEventListener('click', function (event) {
                email = $('#email').val();
                nombre = $('#nombre').val();
                apellido = $('#apellido').val();
                edad = $('#edad').val();
                alias = $('#alias').val();
                avatar = $('#avatar').val();

                $('#myModal').modal('toggle');
                socket.id = id;
                socket.emit('bienvenida', `Soy ${socket.id}, gracias por recibirme`);
            });

            document.getElementById('submitMsg').addEventListener('click', function (event) {
                let mensajes = document.getElementById('mensaje');
                socket.emit('newMsg', {
                    email: email,
                    nombre: nombre,
                    apellido: apellido,
                    edad: parseInt(edad),
                    alias: alias,
                    avatar: avatar,
                    text: mensajes.value
                });
                mensaje.value = '';
            });
            //-------------NORMALIZADO------------------
            // const normalize = normalizr.normalize;
            // const denormalize = normalizr.denormalize;
            // const schema = normalizr.schema;

            // function normaPons(data) {
            //     const user = new schema.Entity('users');

            //     const mensaje = new schema.Entity(
            //         'mensajes',
            //         {
            //             author: [user]
            //         },
            //         { idAttribute: '_id' }
            //     );

            //     const normalizedData = normalize(originalData, [mensaje]);

            //     return normalizedData;
            // }
            //------------------------------------------
            socket.on('recargMsg', function (mensajes) {
                let msgLista = document.getElementById('msgList');
                // mjes = normaPons(mensajes);
                // console.log(mjes);
                msgLista.innerHTML = '';
                mensajes.forEach((elem) => {
                    let cadaMsg = `<li>
                            <a target="_blank" href="mailto:${elem.author[0].email}">${elem.author[0].nombre}</a>
                            <a href="#" class="float-right">${elem.fecha}</a>
                            <p>
                                ${elem.text}
                            </p>
                        </li>`;
                    msgLista.innerHTML += cadaMsg;
                });
                return;
            });
        </script>
    </body>
</html>
